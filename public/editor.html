<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ゲームクリエイター - エディタ</title>
  <!-- Preconnect for faster font loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Non-blocking font loading -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="/style.css">
  <!-- Cropper CSS: lazy load (only needed when editing assets) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" media="print" onload="this.media='all'">
  <meta name="description" content="チャットで会話するだけで、オリジナルのゲームが作れます。">
  <!-- Early auth check: redirect to login if no session (before any JS loads) -->
  <script>
    (function() {
      var cached = localStorage.getItem('dreamcore_session_cache');
      if (!cached) { window.location.href = '/'; return; }
      try {
        var data = JSON.parse(cached);
        if (Date.now() - data.timestamp > 300000) {
          localStorage.removeItem('dreamcore_session_cache');
          window.location.href = '/';
        }
      } catch(e) { window.location.href = '/'; }
    })();
    // Supabase config + lazy loader (SDK loads on first use, not at page load)
    window.__SUPABASE__ = {
      url: 'https://tcynrijrovktirsvwiqb.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjeW5yaWpyb3ZrdGlyc3Z3aXFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjY5OTAsImV4cCI6MjA4NDYwMjk5MH0.y-_E-vuQg84t8BGISdPL18oaYcayS8ip1OLJsZwM3hI'
    };
    window.__loadSupabase = function() {
      if (window.supabase) return Promise.resolve();
      return new Promise(function(resolve) {
        var s = document.createElement('script');
        s.src = '/lib/supabase.min.js';
        s.onload = resolve;
        document.head.appendChild(s);
      });
    };
  </script>
</head>
<body data-page="editor">
  <!-- Project Editor View -->
  <div class="container" id="editorView">
    <!-- Left: Chat Panel -->
    <div class="chat-panel" id="chatPanel">
      <div class="chat-header">
        <button id="homeButton" class="home-btn" title="プロジェクト一覧へ戻る">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
        </button>
        <h1 id="projectTitle" title="クリックで名前を変更">ゲームクリエイター</h1>
        <div class="header-actions">
          <button id="playGameButton" title="ゲームを遊ぶ">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            遊ぶ
          </button>
          <button id="publishButton" class="publish-btn" title="ゲームを登録">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            登録
          </button>
          <span id="statusIndicator" style="display: none;">接続中...</span>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <!-- Static welcome (icon/title/desc stays, only examples update) -->
        <div class="welcome-message" id="welcomeMessage">
          <div class="welcome-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
              <line x1="8" y1="21" x2="16" y2="21"></line>
              <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
          </div>
          <h3>ようこそ！</h3>
          <p>どんなゲームを作りたいですか？<br>自由に話しかけてください。</p>
          <div class="welcome-examples" id="welcomeExamples">
            <span class="example-label">例えば...</span>
            <div class="example-chips">
              <span class="example-chip loading">読み込み中...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Streaming Output Display -->
      <div class="streaming-container hidden" id="streamingContainer">
        <div class="streaming-header">
          <span class="streaming-status" id="streamingStatus">生成中...</span>
          <span class="streaming-file" id="streamingFile"></span>
        </div>
        <div class="streaming-output" id="streamingOutput"></div>
      </div>

      <!-- Debug Options (Hidden by default via CSS) -->
      <div class="debug-options">
        <label class="toggle-switch">
          <input type="checkbox" id="disableSkillsToggle">
          <span class="toggle-slider"></span>
          <span class="toggle-label">スキル無効</span>
        </label>
        <label class="toggle-switch">
          <input type="checkbox" id="useClaudeToggle">
          <span class="toggle-slider"></span>
          <span class="toggle-label">Claude CLI使用</span>
        </label>
      </div>

      <div class="chat-input-container">
        <div id="attachedAssets" class="attached-assets hidden"></div>
        <div class="input-row">
          <!-- Mobile Plus Button -->
          <button id="plusMenuButton" class="plus-menu-btn" title="メニュー">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
          <!-- Plus Menu Popup -->
          <div id="plusMenuPopup" class="plus-menu-popup hidden">
            <button id="plusMenuHistory" class="plus-menu-item">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span>変更履歴</span>
            </button>
          </div>
          <!-- Mobile Image Button -->
          <button id="imageMenuButton" class="image-menu-btn" title="画像">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
          </button>
          <!-- Image Menu Popup -->
          <div id="imageMenuPopup" class="image-menu-popup hidden">
            <button id="imageMenuAsset" class="plus-menu-item">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              <span>素材</span>
            </button>
            <button id="imageMenuUpload" class="plus-menu-item">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>アップロード</span>
            </button>
            <button id="imageMenuImageGen" class="plus-menu-item">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span>画像生成</span>
            </button>
          </div>
          <div class="chat-input-wrapper">
            <textarea
              id="chatInput"
              placeholder="自由に話しかけてください"
              rows="1"
              disabled
            ></textarea>
            <!-- Expand to fullscreen button (inside textarea) -->
            <button id="expandChatButton" class="expand-chat-btn" title="全画面で入力">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="15 3 21 3 21 9"></polyline>
                <polyline points="9 21 3 21 3 15"></polyline>
              </svg>
            </button>
          </div>
        </div>
        <div class="input-buttons">
          <button id="sendButton" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
            送信
          </button>
          <button id="stopButton" class="hidden">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="6" y="6" width="12" height="12"></rect>
            </svg>
            停止
          </button>
        </div>
      </div>
      <div class="input-extras">
        <button id="assetButton" title="素材を追加">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
          </svg>
          素材
        </button>
        <button id="uploadButton" title="ファイルをアップロード">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          アップロード
        </button>
        <button id="imageGenButton" title="AIで画像を作成">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
          画像生成
        </button>
      </div>
    </div>

    <!-- Asset Library Modal -->
    <div class="modal hidden" id="assetModal">
      <div class="modal-content asset-modal">
        <div class="modal-header">
          <h3>素材ライブラリ</h3>
          <button class="modal-close" id="closeAssetModal">&times;</button>
        </div>
        <div class="asset-tabs">
          <button class="asset-tab active" data-tab="my-assets">マイ素材</button>
          <button class="asset-tab" data-tab="public-assets">みんなの素材</button>
          <button class="asset-tab" data-tab="upload">アップロード</button>
        </div>
        <div class="asset-content">
          <!-- My Assets Tab -->
          <div class="asset-tab-content active" id="my-assets">
            <div class="asset-search">
              <input type="text" id="assetSearch" placeholder="素材を検索...">
            </div>
            <div class="asset-grid" id="myAssetGrid">
              <!-- Assets will be loaded here -->
            </div>
          </div>
          <!-- Public Assets Tab -->
          <div class="asset-tab-content" id="public-assets">
            <div class="asset-grid" id="publicAssetGrid">
              <!-- Public assets will be loaded here -->
            </div>
          </div>
          <!-- Upload Tab -->
          <div class="asset-tab-content" id="upload">
            <div class="upload-area" id="uploadArea">
              <input type="file" id="fileInput" accept="image/*,audio/*,.json" multiple hidden>
              <div class="upload-prompt">
                <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p>ファイルをドラッグ＆ドロップ</p>
                <p>またはクリックして選択</p>
                <p class="upload-hint">
                  画像: JPG, PNG（自動圧縮）, GIF, WebP（300KBまで）, SVG<br>
                  音声: MP3, WAV, OGG（1MBまで）
                </p>
              </div>
            </div>
            <div class="upload-form hidden" id="uploadForm">
              <input type="text" id="assetTags" placeholder="タグ（カンマ区切り）">
              <input type="text" id="assetDescription" placeholder="説明（任意）">
              <button id="uploadSubmit">アップロード</button>
            </div>
            <div class="upload-preview" id="uploadPreview"></div>
          </div>
        </div>
        <div class="asset-footer">
          <button id="deleteAssetButton" class="icon-btn icon-btn-danger hidden" title="削除">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
          <span id="selectedAssetInfo" class="asset-selected-name"></span>
          <div class="asset-footer-buttons">
            <button id="editAssetButton" class="secondary-action-btn hidden">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              編集
            </button>
            <button id="insertAssetButton" class="primary-action-btn hidden">
              挿入
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Editor Modal -->
    <div class="modal hidden" id="imageEditorModal">
      <div class="modal-content image-editor-modal">
        <div class="modal-header">
          <h3>画像を編集</h3>
          <button class="modal-close" id="closeImageEditor">&times;</button>
        </div>
        <div class="image-editor-body">
          <div class="editor-canvas-area">
            <div class="canvas-wrapper">
              <canvas id="editorCanvas"></canvas>
            </div>
            <!-- Cropper.js container (shown only in crop mode) -->
            <div class="cropper-container-wrapper hidden" id="cropperWrapper">
              <img id="cropperImage" src="" alt="Crop preview">
            </div>
          </div>
          <div class="editor-toolbar">
            <button class="tool-btn" data-tool="crop" title="切り抜き">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 2v4H2v2h4v12h12v4h2v-4h4v-2H8V6h12V4H8V2z"/>
              </svg>
              <span>クロップ</span>
            </button>
            <button class="tool-btn" data-tool="resize" title="リサイズ">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 21l-6-6m6 6v-4.8m0 4.8h-4.8"/>
                <path d="M3 16.2V21m0 0h4.8M3 21l6-6"/>
                <path d="M21 7.8V3m0 0h-4.8M21 3l-6 6"/>
                <path d="M3 7.8V3m0 0h4.8M3 3l6 6"/>
              </svg>
              <span>リサイズ</span>
            </button>
            <button class="tool-btn" id="rotateRight" title="90°回転">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 11-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                <path d="M21 3v5h-5"/>
              </svg>
              <span>回転</span>
            </button>
            <button class="tool-btn" id="flipHorizontal" title="左右反転">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3v18"/>
                <path d="M16 7l4 5-4 5"/>
                <path d="M8 7l-4 5 4 5"/>
              </svg>
              <span>左右</span>
            </button>
            <button class="tool-btn" id="flipVertical" title="上下反転">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12h18"/>
                <path d="M7 8l5-4 5 4"/>
                <path d="M7 16l5 4 5-4"/>
              </svg>
              <span>上下</span>
            </button>
            <button class="tool-btn" data-tool="remove-bg" title="背景削除">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <circle cx="12" cy="12" r="4"/>
                <path d="M3 3l18 18"/>
              </svg>
              <span>背景削除</span>
            </button>
            <button id="editorUndo" class="tool-btn" disabled title="元に戻す">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 7v6h6"/>
                <path d="M3 13a9 9 0 1 0 3-7.7L3 7"/>
              </svg>
              <span>戻す</span>
            </button>
            <button id="editorReset" class="tool-btn" title="リセット">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
              </svg>
              <span>リセット</span>
            </button>
          </div>
          <div class="tool-panels">
            <div class="tool-panel hidden" id="cropPanel">
              <div class="panel-title">クロップ設定</div>
              <div class="preset-ratios">
                <button class="ratio-btn active" data-ratio="free">
                  <span class="ratio-shape ratio-free"></span>
                  <span class="ratio-label">フリー</span>
                </button>
                <button class="ratio-btn" data-ratio="1:1">
                  <span class="ratio-shape ratio-1-1"></span>
                  <span class="ratio-label">1:1</span>
                </button>
                <button class="ratio-btn" data-ratio="4:3">
                  <span class="ratio-shape ratio-4-3"></span>
                  <span class="ratio-label">4:3</span>
                </button>
                <button class="ratio-btn" data-ratio="16:9">
                  <span class="ratio-shape ratio-16-9"></span>
                  <span class="ratio-label">16:9</span>
                </button>
                <button class="ratio-btn" data-ratio="9:16">
                  <span class="ratio-shape ratio-9-16"></span>
                  <span class="ratio-label">9:16</span>
                </button>
                <button class="ratio-btn" data-ratio="circle">
                  <span class="ratio-shape ratio-circle"></span>
                  <span class="ratio-label">円形</span>
                </button>
              </div>
              <div class="crop-info">
                <span id="cropSizeInfo">ハンドルをドラッグして調整</span>
              </div>
              <div class="panel-actions">
                <button class="panel-cancel-btn" data-cancel-tool>キャンセル</button>
                <button id="applyCrop" class="apply-btn">適用</button>
              </div>
            </div>
            <div class="tool-panel hidden" id="resizePanel">
              <div class="panel-title">リサイズ設定</div>
              <div class="resize-inputs">
                <div class="input-group">
                  <label>幅</label>
                  <input type="number" id="resizeWidth" min="1" max="4096">
                  <span>px</span>
                </div>
                <div class="input-group">
                  <label>高さ</label>
                  <input type="number" id="resizeHeight" min="1" max="4096">
                  <span>px</span>
                </div>
              </div>
              <label class="checkbox-label">
                <input type="checkbox" id="keepAspect" checked>
                縦横比を維持
              </label>
              <div class="panel-actions">
                <button class="panel-cancel-btn" data-cancel-tool>キャンセル</button>
                <button id="applyResize" class="apply-btn">適用</button>
              </div>
            </div>
            <div class="tool-panel hidden" id="removeBgPanel">
              <div class="panel-title">背景削除</div>
              <p class="panel-desc">BRIA RMBG 2.0で高精度に背景を透明化</p>
              <div class="panel-actions">
                <button class="panel-cancel-btn" data-cancel-tool>キャンセル</button>
                <button id="applyRemoveBg" class="apply-btn">背景を削除</button>
              </div>
              <div class="processing-indicator hidden" id="bgProcessing">
                <div class="spinner"></div>
                <span>処理中...</span>
              </div>
            </div>
          </div>
        </div>
        <div class="image-editor-footer">
          <button id="cancelEdit" class="secondary-btn">キャンセル</button>
          <button id="saveEditedImage" class="primary-btn">保存</button>
        </div>
      </div>
    </div>

    <!-- Image Generation Modal -->
    <div class="modal hidden" id="imageGenModal">
      <div class="modal-content image-gen-modal">
        <div class="modal-header">
          <h3>AIで画像を作成</h3>
          <button class="modal-close" id="closeImageGenModal">&times;</button>
        </div>
        <div class="image-gen-content">
          <div class="image-gen-form">
            <label class="form-label">どんな画像を作りますか？</label>
            <textarea id="imageGenPrompt" placeholder="例：かわいい猫のキャラクター、宇宙船、ファンタジーの森..." rows="3"></textarea>
            <div class="image-gen-options">
              <div class="option-group">
                <label class="option-label">スタイル</label>
                <select id="imageGenStyle">
                  <option value="">おまかせ</option>
                  <option value="pixel">ピクセルアート</option>
                  <option value="anime">アニメ風</option>
                  <option value="kawaii">かわいい系</option>
                  <option value="realistic">リアル調</option>
                  <option value="watercolor">水彩画風</option>
                  <option value="flat">フラットデザイン</option>
                </select>
              </div>
              <div class="option-group">
                <label class="option-label">サイズ</label>
                <select id="imageGenSize">
                  <option value="512x512">正方形</option>
                  <option value="768x512">横長</option>
                  <option value="512x768">縦長</option>
                  <option value="1024x1024">大きめ</option>
                </select>
              </div>
            </div>
            <button id="generateImageButton" class="generate-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
              </svg>
              画像を生成
            </button>
          </div>
          <div class="image-gen-preview">
            <div class="image-placeholder" id="imagePlaceholder">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span>生成された画像がここに表示されます</span>
            </div>
            <img id="generatedImage" class="hidden" alt="生成された画像">
            <div class="image-gen-loading hidden" id="imageGenLoading">
              <div class="spinner"></div>
              <span>画像を作成しています...</span>
            </div>
          </div>
        </div>
        <div class="image-gen-footer">
          <button id="insertImageButton" class="hidden" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            チャットに挿入
          </button>
          <button id="downloadImageButton" class="hidden" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- Right: Game Preview -->
    <div class="preview-panel" id="previewPanel">
      <div class="preview-header">
        <button id="backToChatButton" class="back-to-chat-btn" title="チャットに戻る">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          チャット
        </button>
        <div class="preview-actions">
          <button id="viewCodeButton" class="icon-only-btn hidden" title="HTMLを見る">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
          </button>
          <button id="downloadButton" class="icon-only-btn hidden" title="ダウンロード">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>
          <button id="versionsButton" class="icon-only-btn hidden" title="履歴を見る">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </button>
          <button id="refreshButton" title="再読み込み">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="preview-container">
        <iframe id="gamePreview" sandbox="allow-scripts allow-same-origin"></iframe>
        <div class="no-project-message" id="noProjectMessage">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
            <line x1="8" y1="21" x2="16" y2="21"></line>
            <line x1="12" y1="17" x2="12" y2="21"></line>
          </svg>
          <p>プロジェクトを選んで<br>ゲームを作り始めましょう</p>
        </div>

        <!-- Error Panel -->
        <div class="error-panel hidden" id="errorPanel">
          <div class="error-panel-header">
            <span class="error-panel-title">
              <svg class="error-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              <span id="errorCount">0</span>件のエラー
            </span>
            <div class="error-panel-actions">
              <button id="autoFixButton" class="auto-fix-btn" title="AIで自動修正">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
                自動修正
              </button>
              <button id="closeErrorPanel" class="close-btn" title="閉じる">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
          <div class="error-panel-content" id="errorList">
            <!-- Errors will be listed here -->
          </div>
        </div>

        <!-- Game Status Overlay -->
        <div class="game-status hidden" id="gameStatus">
          <span class="game-status-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
          </span>
          <span class="game-status-text" id="gameStatusText">読み込み中...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Code Viewer Modal -->
  <div class="code-viewer-modal hidden" id="codeViewerModal">
    <div class="code-viewer-content">
      <div class="code-viewer-header">
        <h3>HTML コード</h3>
        <div class="code-viewer-actions">
          <button id="copyCodeButton" class="code-action-btn" title="コピー">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            コピー
          </button>
          <button id="closeCodeViewer" class="code-close-btn">&times;</button>
        </div>
      </div>
      <pre class="code-viewer-pre"><code id="codeViewerCode"></code></pre>
    </div>
  </div>

  <!-- Version Restore Modal -->
  <div class="restore-modal hidden" id="restoreModal">
    <div class="restore-modal-content">
      <div class="restore-modal-header">
        <div class="restore-modal-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <h2>バージョンを復元</h2>
      </div>
      <div class="restore-modal-body">
        <p id="restoreModalMessage">このバージョンに戻しますか？</p>
        <p class="restore-modal-hint">現在のバージョンにもいつでも戻れます</p>
      </div>
      <div class="restore-modal-actions">
        <button id="cancelRestore" class="restore-modal-cancel">キャンセル</button>
        <button id="confirmRestore" class="restore-modal-confirm">復元する</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="restore-modal hidden" id="deleteConfirmModal">
    <div class="restore-modal-content">
      <div class="restore-modal-header">
        <div class="restore-modal-icon" style="background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
        </div>
        <h2 id="deleteConfirmTitle">アセットを削除</h2>
      </div>
      <div class="restore-modal-body">
        <p id="deleteConfirmMessage">このアセットを削除しますか？</p>
        <p class="restore-modal-hint">この操作は取り消せません</p>
      </div>
      <div class="restore-modal-actions">
        <button id="cancelDelete" class="restore-modal-cancel">キャンセル</button>
        <button id="confirmDelete" class="restore-modal-confirm">削除する</button>
      </div>
    </div>
  </div>

  <script src="/auth.js" defer></script>
  <script src="/app.js" defer></script>
  <!-- Cropper.js: lazy load (only needed when editing assets) -->
  <script>
    window.loadCropper = () => {
      if (window.Cropper) return Promise.resolve();
      return new Promise(resolve => {
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js';
        s.onload = resolve;
        document.head.appendChild(s);
      });
    };
  </script>

  <!-- Version Panel (outside container for mobile overlay) -->
  <div class="version-panel hidden" id="versionPanel">
    <div class="version-header">
      <span>変更履歴</span>
      <button id="closeVersionsButton">&times;</button>
    </div>
    <div class="version-list" id="versionList">
      <!-- Versions will be inserted here -->
    </div>
  </div>

  <!-- Chat Fullscreen Overlay -->
  <div class="chat-fullscreen-overlay" id="chatFullscreenOverlay">
    <div class="chat-fullscreen-header">
      <h3>メッセージを入力</h3>
      <button class="chat-fullscreen-close" id="closeChatFullscreen">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <textarea class="chat-fullscreen-textarea" id="chatFullscreenInput" placeholder="自由に話しかけてください"></textarea>
    <div class="chat-fullscreen-actions">
      <button class="chat-fullscreen-cancel" id="cancelChatFullscreen">キャンセル</button>
      <button class="chat-fullscreen-send" id="sendChatFullscreen">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
        送信
      </button>
    </div>
  </div>
</body>
</html>
